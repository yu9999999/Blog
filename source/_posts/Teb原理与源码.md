---
title: Teb原理与源码
date: 2023-11-29 
tags:
- Teb
- 局部路径规划算法
- ROS
- 机器人
categories:
- 机器人路径规划算法
aside: false
---
**原理：** 这里是结合源码进行讲解的，用于局部路径规划，从数学角度也就是一个多目标最优化问题，通过设计代价函数（损失函数），然后求出最小代价值，获取最优的路径点，从而得到相应的速度。
1.从全局规划中获取局部路径点（也就是对路径点增删操作），这里暂且将这些点的位姿与时间作为向量变量，假设为x，将获取的局部路径点作为初始值x0
2.设置代价函数。在没有对路径点进行操作时，其路径代价函数可能是fpath(x0)=0（优化后的全局路径点没改变的化），其余的还有障碍物代价函数、速度、加速度、运动学、最短路径等代价函数。源码上的代价函数稍后简单介绍一下。
3.最后就是最小化代价函数，通过迭代找到最小代价值与其的对应的最优值x，此时x包含着位姿和时间，将这些点最为轨迹点，形成一条轨迹，也就是规划的行驶路线
4.通过两点位姿可以计算出对应的速度（线速度与角速度）
5.最后发布速度
注意：这里再求最优轨迹点时，用的是g2o库，其原理也就是迭代法，具体选择高斯牛顿法还是LM法，看自己需求。同时提一嘴，g2o也可以用于建图。在g2o中，顶点就是一些变量（路径点姿态，时间，移动障碍物等），如果1个误差函数与5个顶点相关，则连接5个顶点到误差函数形成5条边，然后设置好权重（一般误差函数是几维，权重就是几维对角阵），最后就是求最小误差函数（这个就是g2o自动去计算了）。再提一嘴，迭代法应用十分广泛，机器学习、深度学习很多原理都会用到，原理都十分简单。由于计算机性能问题，目前能求二阶导，也就是Hessian 矩阵已经不得了了，常见的还是雅可比矩阵。所以对数学来说相对简单，很少涉及到高阶求导，只是还需仔细阅读源码。

**teb代价函数计算：** 误差*权重
1.障碍物代价值：首先判断是否进行了障碍物膨胀，之后定义了一个创建边的函数，如下所示，障碍物边是名为EdgeObstacle的类。之后，遍历每一个坐标点，找到离坐标点距离小于阈值的障碍物，以及左侧和右侧最近的障碍物，构建EdgeObstacle对象，作为图的障碍物边。边误差的计算为，当障碍物距离大于参数min_obstacle_dist时，都返回penalty_epsilon（相当于0）；反之返回与min_obstacle_dist距离差。这个计算公式有点像Relu激活函数。
2.via_point代价值：首先遍历每一个路径点，计算与当前路径点最近的全局路径坐标点，构建路径点边，边的误差计算就是欧氏距离。
3.速度代价值：这里进行一个处理，通过两点位姿可以计算两点距离与角度，从而求得弧长，从而获得线速度与角速度。边的误差计算就是与最大后退速度，最大x速度，最大角速度进行对比，在阈值内代价值为0，反之为其差。目的是防止线速度和角速度超过给定阈值。
4.加速度：与速度一样，保持在阈值内。
5.时间：其代价值就是时间大小，时间越大代价值也就越大。
6.最短化边：也就是两点距离，距离越小值越小。
7.运动学：第一个误差函数是(cos(t1)+cos(t2)-sin(t1)-sin(t2))*两点距离，在差动机器人中第二个误差函数是计算旋转误差（机器人位姿旋转到两点方向），小于90度误差为0，大于90度越大计算出的误差也就越大，如果该权重设大，说明最好前向移动

**teb与dwa原理对比：**
teb是先将全局路径点作为初始轨迹点，然后通过最小化代价值（这些代价值是与全局路径点、障碍物等有关的），通过g2o找到最优路径点，然后再去计算相应速度作为规划速度将其发布下去
dwa是先将速度区间通过样本数划分多个速度样本，然后将每个速度样本*t得出一条轨迹，再去将轨迹与全局路径、障碍物这些进行计算，也算是计算代价值，然后找到最小代价值对应的速度样本，将其作为规划速度发不下去